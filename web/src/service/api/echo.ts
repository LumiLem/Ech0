import { request, requestWithDirectUrlAndData } from '../request'

// 分页获取Echos
export function fetchGetEchosByPage(searchParams: App.Api.Ech0.ParamsByPagination) {
  return request<App.Api.Ech0.PaginationResult>({
    url: `/echo/page`,
    method: 'POST',
    data: searchParams,
  })
}

// 上传媒体文件（图片或视频）
export function fetchUploadMedia(file: File) {
  const formData = new FormData()
  formData.append('file', file)
  return request<string>({
    url: `/images/upload`,
    method: 'POST',
    data: formData,
  })
}

// 上传图片（向后兼容）
export const fetchUploadImage = fetchUploadMedia

// 添加Echo
export function fetchAddEcho(echoToAdd: App.Api.Ech0.EchoToAdd) {
  return request({
    url: `/echo`,
    method: 'POST',
    data: echoToAdd,
  })
}

// 删除Echo
export function fetchDeleteEcho(echoId: number) {
  return request({
    url: `/echo/${echoId}`,
    method: 'DELETE',
  })
}

// 更新Echo
export function fetchUpdateEcho(echo: App.Api.Ech0.EchoToUpdate) {
  return request({
    url: `/echo`,
    method: 'PUT',
    data: echo,
  })
}

// 点赞Echo
export function fetchLikeEcho(echoId: number) {
  return request({
    url: `/echo/like/${echoId}`,
    method: 'PUT',
  })
}

// 获取Echo详情
export function fetchGetEchoById(echoId: string) {
  return request<App.Api.Ech0.Echo>({
    url: `/echo/${echoId}`,
    method: 'GET',
  })
}

// 获取status
export function fetchGetStatus() {
  return request<App.Api.Ech0.Status>({
    url: `/status`,
    method: 'GET',
  })
}

// 获取热力图数据
// 不传参数返回近30天数据，传year和month返回指定月份数据
export function fetchGetHeatMap(year?: number, month?: number) {
  const params = year && month ? `?year=${year}&month=${month}` : ''
  return request<App.Api.Ech0.HeatMap>({
    url: `/heatmap${params}`,
    method: 'GET',
  })
}

// 删除媒体文件（图片或视频）
export function fetchDeleteMedia(media: App.Api.Ech0.MediaToDelete) {
  return request({
    url: `/images/delete`,
    method: 'DELETE',
    data: media,
  })
}

// 删除Image（向后兼容）
export const fetchDeleteImage = fetchDeleteMedia

// 获取Github仓库数据
export function fetchGetGithubRepo(githubRepo: { owner: string; repo: string }) {
  return requestWithDirectUrlAndData<App.Api.Ech0.GithubCardData>({
    dirrectUrlAndData: `https://api.github.com/repos/${githubRepo.owner}/${githubRepo.repo}`,
    url: `/github`,
    method: 'GET',
  })
}

// 获取预签名URL
export function fetchGetPresignedUrl(fileName: string, contentType?: string) {
  return request<App.Api.Ech0.PresignResult>({
    url: `/s3/presign`,
    method: 'PUT',
    data: {
      file_name: fileName,
      content_type: contentType,
    },
  })
}

// 获取标签列表
export function fetchGetTags() {
  return request<App.Api.Ech0.Tag[]>({
    url: `/tags`,
    method: 'GET',
  })
}

// 删除某个标签
export function fetchDeleteTagById(tagId: number) {
  return request({
    url: `/tag/${tagId}`,
    method: 'DELETE',
  })
}

// 根据标签查询Echos（支持分页）
export function fetchGetEchosByTagId(tagId: number, searchParams: App.Api.Ech0.ParamsByPagination) {
  return request<App.Api.Ech0.PaginationResult>({
    url: `/echo/tag/${tagId}?page=${searchParams.page}&pageSize=${searchParams.pageSize}&search=${searchParams.search || ''}`,
    method: 'GET',
  })
}

// 根据日期查询Echos（支持分页）
// date: 具体日期 YYYY-MM-DD，或者传 year 和 month 获取整月数据
export function fetchGetEchosByDate(
  searchParams: App.Api.Ech0.ParamsByPagination & { date?: string; year?: number; month?: number }
) {
  const { page, pageSize, search, date, year, month } = searchParams
  let params = `page=${page}&pageSize=${pageSize}&search=${search || ''}`
  if (date) {
    params += `&date=${date}`
  } else if (year && month) {
    params += `&year=${year}&month=${month}`
  }
  return request<App.Api.Ech0.PaginationResult>({
    url: `/echo/date?${params}`,
    method: 'GET',
  })
}

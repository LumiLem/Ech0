package service

import (
	"context"
	"errors"
	"strings"

	"github.com/lin-snow/ech0/internal/event"
	authModel "github.com/lin-snow/ech0/internal/model/auth"
	commonModel "github.com/lin-snow/ech0/internal/model/common"
	model "github.com/lin-snow/ech0/internal/model/echo"
	commonRepository "github.com/lin-snow/ech0/internal/repository/common"
	repository "github.com/lin-snow/ech0/internal/repository/echo"
	keyvalueRepository "github.com/lin-snow/ech0/internal/repository/keyvalue"
	commonService "github.com/lin-snow/ech0/internal/service/common"
	fediverseService "github.com/lin-snow/ech0/internal/service/fediverse"
	"github.com/lin-snow/ech0/internal/service/livephoto"
	"github.com/lin-snow/ech0/internal/transaction"
	httpUtil "github.com/lin-snow/ech0/internal/util/http"
	logUtil "github.com/lin-snow/ech0/internal/util/log"
	"go.uber.org/zap"
)

type EchoService struct {
	txManager        transaction.TransactionManager
	commonService    commonService.CommonServiceInterface
	echoRepository   repository.EchoRepositoryInterface
	commonRepository commonRepository.CommonRepositoryInterface
	fediverseService fediverseService.FediverseServiceInterface
	kvRepository     keyvalueRepository.KeyValueRepositoryInterface
	eventBus         event.IEventBus
}

func NewEchoService(
	tm transaction.TransactionManager,
	commonService commonService.CommonServiceInterface,
	echoRepository repository.EchoRepositoryInterface,
	commonRepository commonRepository.CommonRepositoryInterface,
	fediverseService fediverseService.FediverseServiceInterface,
	kvRepository keyvalueRepository.KeyValueRepositoryInterface,
	eventBusProvider func() event.IEventBus,
) EchoServiceInterface {
	return &EchoService{
		txManager:        tm,
		commonService:    commonService,
		echoRepository:   echoRepository,
		commonRepository: commonRepository,
		fediverseService: fediverseService,
		kvRepository:     kvRepository,
		eventBus:         eventBusProvider(),
	}
}

// PostEcho 创建新的Echo
func (echoService *EchoService) PostEcho(userid uint, newEcho *model.Echo) error {
	newEcho.UserID = userid

	user, err := echoService.commonService.CommonGetUserByUserId(userid)
	if err != nil {
		return err
	}

	if !user.IsAdmin {
		return errors.New(commonModel.NO_PERMISSION_DENIED)
	}

	// 检查图片布局
	layout := strings.TrimSpace(newEcho.Layout)
	if layout == "" || (layout != model.LayoutWaterfall &&
		layout != model.LayoutGrid &&
		layout != model.LayoutHorizontal &&
		layout != model.LayoutCarousel) {
		newEcho.Layout = model.LayoutWaterfall
	}

	// 检查Extension内容
	if newEcho.Extension != "" && newEcho.ExtensionType != "" {
		switch newEcho.ExtensionType {
		case model.Extension_MUSIC:
			// 处理音乐链接 (暂无)
		case model.Extension_VIDEO:
			// 处理视频链接 (暂无)
		case model.Extension_GITHUBPROJ:
			// 处理GitHub项目的链接
			newEcho.Extension = httpUtil.TrimURL(newEcho.Extension)
		case model.Extension_WEBSITE:
			// 处理网站链接 (暂无)
		}
	} else {
		newEcho.Extension = ""
		newEcho.ExtensionType = ""
	}

	newEcho.Username = user.Username

	for i := range newEcho.Media {
		if newEcho.Media[i].MediaURL == "" {
			newEcho.Media[i].MediaSource = ""
		}
	}

	if newEcho.Content == "" && len(newEcho.Media) == 0 &&
		(newEcho.Extension == "" || newEcho.ExtensionType == "") {
		return errors.New(commonModel.ECHO_CAN_NOT_BE_EMPTY)
	}

	// 提取 live_pair_id 列表（在保存前提取，保存后用于建立关联）
	pairIDs := make([]string, len(newEcho.Media))
	for i, m := range newEcho.Media {
		pairIDs[i] = m.LivePairID
	}

	if err := echoService.txManager.Run(func(ctx context.Context) error {
		// 处理标签
		if err := echoService.ProcessEchoTags(ctx, newEcho); err != nil {
			return err
		}

		// 处理临时文件表，防止被当作孤儿文件删除
		for i := range newEcho.Media {
			// 只有S3媒体且有ObjectKey的才处理
			if newEcho.Media[i].MediaSource == model.MediaSourceS3 && newEcho.Media[i].ObjectKey != "" {
				// 使用外层事务的 ctx 直接调用仓储层方法
				if err := echoService.commonRepository.DeleteTempFileByObjectKey(ctx, newEcho.Media[i].ObjectKey); err != nil {
					logUtil.GetLogger().Error("Failed to process temp file for ObjectKey: ", zap.String("Media ObjectKey", newEcho.Media[i].ObjectKey))
					return err
				}
				logUtil.GetLogger().Info("Processed temp file for ObjectKey: ", zap.String("Media ObjectKey", newEcho.Media[i].ObjectKey))
			}
		}

		// 创建Echo
		if err := echoService.echoRepository.CreateEcho(ctx, newEcho); err != nil {
			return err
		}

		// 处理实况照片关联（根据 live_pair_id 建立关联）
		livePhotoPairs := livephoto.ProcessLivePhotoPairs(newEcho.Media, pairIDs)
		if len(livePhotoPairs) > 0 {
			for imgIdx, vidIdx := range livePhotoPairs {
				if imgIdx < len(newEcho.Media) && vidIdx < len(newEcho.Media) {
					imgMedia := &newEcho.Media[imgIdx]
					vidMedia := &newEcho.Media[vidIdx]
					// 设置图片的 LiveVideoID 指向视频
					if vidMedia.ID > 0 {
						imgMedia.LiveVideoID = &vidMedia.ID
						if err := echoService.echoRepository.UpdateMediaLiveVideoID(ctx, imgMedia.ID, vidMedia.ID); err != nil {
							logUtil.GetLogger().Error("Failed to update live photo association", zap.Uint("imageID", imgMedia.ID), zap.Uint("videoID", vidMedia.ID))
							return err
						}
						logUtil.GetLogger().Info("Created live photo association", zap.Uint("imageID", imgMedia.ID), zap.Uint("videoID", vidMedia.ID))
					}
				}
			}
		}

		return nil
	}); err != nil {
		return err
	}

	// 事务提交成功后再推送，确保已拿到持久化 ID
	savedEcho, fetchErr := echoService.echoRepository.GetEchosById(newEcho.ID)
	if fetchErr != nil {
		return fetchErr
	}
	if savedEcho != nil {
		// 推送事件(Webhook, Fediverse, Agent等)
		if pubErr := echoService.eventBus.Publish(
			context.Background(),
			event.NewEvent(
				event.EventTypeEchoCreated,
				event.EventPayload{
					event.EventPayloadEcho: *savedEcho,
					event.EventPayloadUser: user,
				},
			),
		); pubErr != nil {
			// 推送失败不影响发布
			logUtil.GetLogger().Error(pubErr.Error())
		}
	}

	return nil
}

// GetEchosByPage 获取Echo列表，支持分页
func (echoService *EchoService) GetEchosByPage(
	userid uint,
	pageQueryDto commonModel.PageQueryDto,
) (commonModel.PageQueryResult[[]model.Echo], error) {
	// 参数校验
	if pageQueryDto.Page < 1 {
		pageQueryDto.Page = 1
	}
	if pageQueryDto.PageSize < 1 || pageQueryDto.PageSize > 100 {
		pageQueryDto.PageSize = 10
	}

	// 管理员登陆则支持查看隐私数据，否则不允许
	showPrivate := false
	if userid == authModel.NO_USER_LOGINED {
		showPrivate = false
	} else {
		user, err := echoService.commonService.CommonGetUserByUserId(userid)
		if err != nil {
			return commonModel.PageQueryResult[[]model.Echo]{}, err
		}
		if user.IsAdmin {
			showPrivate = true
		} else {
			showPrivate = false
		}
	}

	echosByPage, total := echoService.echoRepository.GetEchosByPage(
		pageQueryDto.Page,
		pageQueryDto.PageSize,
		pageQueryDto.Search,
		showPrivate,
	)
	result := commonModel.PageQueryResult[[]model.Echo]{
		Items: echosByPage,
		Total: total,
	}

	// 处理echosByPage中的图片URL (暂不处理，防止拖慢列表加载速度)
	// for i := range result.Items {
	// 	echoService.commonService.RefreshEchoImageURL(&result.Items[i])
	// }

	// 返回结果
	return result, nil
}

// DeleteEchoById 删除指定ID的Echo
func (echoService *EchoService) DeleteEchoById(userid, id uint) error {
	user, err := echoService.commonService.CommonGetUserByUserId(userid)
	if err != nil {
		return err
	}
	if !user.IsAdmin {
		return errors.New(commonModel.NO_PERMISSION_DENIED)
	}

	if err := echoService.txManager.Run(func(ctx context.Context) error {
		// 检查该Echo是否存在图片
		echo, err := echoService.echoRepository.GetEchosById(id)
		if err != nil {
			return err
		}
		if echo == nil {
			return errors.New(commonModel.ECHO_NOT_FOUND)
		}

		// 删除Echo中的媒体
		if len(echo.Media) > 0 {
			for _, m := range echo.Media {
				if err := echoService.commonService.DirectDeleteImage(m.MediaURL, m.MediaSource, m.ObjectKey); err != nil {
					return err
				}
			}
		}

		// 删除Echo
		return echoService.echoRepository.DeleteEchoById(ctx, id)
	}); err != nil {
		return err
	}

	// 删除成功后推送事件
	if pubErr := echoService.eventBus.Publish(
		context.Background(),
		event.NewEvent(
			event.EventTypeEchoDeleted,
			event.EventPayload{
				event.EventPayloadEcho: model.Echo{ID: id},
				event.EventPayloadUser: user,
			},
		),
	); pubErr != nil {
		// 推送失败不影响删除
		logUtil.GetLogger().Error(pubErr.Error())
	}

	return nil
}

// GetTodayEchos 获取今天的Echo列表
func (echoService *EchoService) GetTodayEchos(userid uint) ([]model.Echo, error) {
	// 管理员登陆则支持查看隐私数据，否则不允许
	showPrivate := false
	if userid == authModel.NO_USER_LOGINED {
		showPrivate = false
	} else {
		user, err := echoService.commonService.CommonGetUserByUserId(userid)
		if err != nil {
			return nil, err
		}
		if user.IsAdmin {
			showPrivate = true
		} else {
			showPrivate = false
		}
	}

	// 获取当日发布的Echos
	todayEchos := echoService.echoRepository.GetTodayEchos(showPrivate)

	// 处理todayEchos中的图片URL (暂不处理，防止拖慢列表加载速度)
	// for i := range todayEchos {
	// 	echoService.commonService.RefreshEchoImageURL(&todayEchos[i])
	// }

	return todayEchos, nil
}

// UpdateEcho 更新指定ID的Echo
func (echoService *EchoService) UpdateEcho(userid uint, echo *model.Echo) error {
	user, err := echoService.commonService.CommonGetUserByUserId(userid)
	if err != nil {
		return err
	}
	if !user.IsAdmin {
		return errors.New(commonModel.NO_PERMISSION_DENIED)
	}

	// 检查图片布局
	layout := strings.TrimSpace(echo.Layout)
	if layout == "" || (layout != model.LayoutWaterfall &&
		layout != model.LayoutGrid &&
		layout != model.LayoutHorizontal &&
		layout != model.LayoutCarousel) {
		echo.Layout = model.LayoutWaterfall
	}

	// 检查Extension内容
	if echo.Extension != "" && echo.ExtensionType != "" {
		switch echo.ExtensionType {
		case model.Extension_MUSIC:
			// 处理音乐链接 (暂无)
		case model.Extension_VIDEO:
			// 处理视频链接 (暂无)
		case model.Extension_GITHUBPROJ:
			echo.Extension = httpUtil.TrimURL(echo.Extension)
		case model.Extension_WEBSITE:
			// 处理网站链接 (暂无)
		}
	} else {
		echo.Extension = ""
		echo.ExtensionType = ""
	}

	// 处理无效媒体
	for i := range echo.Media {
		if echo.Media[i].MediaURL == "" {
			echo.Media[i].MediaSource = ""
			echo.Media[i].MediaURL = ""
		}
		// 确保外键正确设置
		echo.Media[i].MessageID = echo.ID
	}

	// 检查是否为空
	if echo.Content == "" && len(echo.Media) == 0 && (echo.Extension == "" || echo.ExtensionType == "") {
		return errors.New(commonModel.ECHO_CAN_NOT_BE_EMPTY)
	}

	// 提取新媒体的 live_pair_id 列表（仅处理没有 ID 的新媒体）
	var newMediaPairIDs []string
	var newMediaIndexes []int
	for i, m := range echo.Media {
		if m.ID == 0 && m.LivePairID != "" {
			newMediaPairIDs = append(newMediaPairIDs, m.LivePairID)
			newMediaIndexes = append(newMediaIndexes, i)
		}
	}

	if err := echoService.txManager.Run(func(ctx context.Context) error {
		// 处理标签
		if err := echoService.ProcessEchoTags(ctx, echo); err != nil {
			return err
		}

		// 处理无效媒体的临时文件表，防止被当作孤儿文件删除
		for i := range echo.Media {
			// 只有S3媒体且有ObjectKey的才处理
			if echo.Media[i].MediaSource == model.MediaSourceS3 && echo.Media[i].ObjectKey != "" {
				// 使用外层事务的 ctx 直接调用仓储层方法
				if err := echoService.commonRepository.DeleteTempFileByObjectKey(ctx, echo.Media[i].ObjectKey); err != nil {
					logUtil.GetLogger().Error("Failed to process temp file for ObjectKey: ", zap.String("Media ObjectKey", echo.Media[i].ObjectKey))
					return err
				}
				logUtil.GetLogger().Info("Processed temp file for ObjectKey: ", zap.String("Media ObjectKey", echo.Media[i].ObjectKey))
			}
		}

		// 更新Echo（保留现有媒体，只新增/删除变化的媒体）
		if err := echoService.echoRepository.UpdateEcho(ctx, echo); err != nil {
			return err
		}

		// 处理新媒体中的实况照片关联（根据 live_pair_id 建立关联）
		if len(newMediaIndexes) > 0 {
			// 提取新媒体
			newMedia := make([]model.Media, len(newMediaIndexes))
			for i, idx := range newMediaIndexes {
				newMedia[i] = echo.Media[idx]
			}

			livePhotoPairs := livephoto.ProcessLivePhotoPairs(newMedia, newMediaPairIDs)
			if len(livePhotoPairs) > 0 {
				for localImgIdx, localVidIdx := range livePhotoPairs {
					// 转换回原始索引
					imgIdx := newMediaIndexes[localImgIdx]
					vidIdx := newMediaIndexes[localVidIdx]
					if imgIdx < len(echo.Media) && vidIdx < len(echo.Media) {
						imgMedia := &echo.Media[imgIdx]
						vidMedia := &echo.Media[vidIdx]
						if vidMedia.ID > 0 {
							imgMedia.LiveVideoID = &vidMedia.ID
							if err := echoService.echoRepository.UpdateMediaLiveVideoID(ctx, imgMedia.ID, vidMedia.ID); err != nil {
								logUtil.GetLogger().Error("Failed to update live photo association", zap.Uint("imageID", imgMedia.ID), zap.Uint("videoID", vidMedia.ID))
								return err
							}
							logUtil.GetLogger().Info("Created live photo association in update", zap.Uint("imageID", imgMedia.ID), zap.Uint("videoID", vidMedia.ID))
						}
					}
				}
			}
		}

		return nil
	}); err != nil {
		return err
	}

	// 更新成功后推送事件
	if pubErr := echoService.eventBus.Publish(
		context.Background(),
		event.NewEvent(
			event.EventTypeEchoUpdated,
			event.EventPayload{
				event.EventPayloadEcho: *echo,
				event.EventPayloadUser: user,
			},
		),
	); pubErr != nil {
		// 推送失败不影响更新
		logUtil.GetLogger().Error(pubErr.Error())
	}

	return nil
}

// LikeEcho 点赞指定ID的Echo
func (echoService *EchoService) LikeEcho(id uint) error {
	return echoService.txManager.Run(func(ctx context.Context) error {
		return echoService.echoRepository.LikeEcho(ctx, id)
	})
}

// GetEchoById 获取指定 ID 的 Echo
func (echoService *EchoService) GetEchoById(userId, id uint) (*model.Echo, error) {
	var echo *model.Echo

	echo, err := echoService.echoRepository.GetEchosById(id)
	if err != nil {
		return nil, err
	}

	// 如果不存在Echo，则返回错误
	if echo == nil {
		return nil, errors.New(commonModel.ECHO_NOT_FOUND)
	}

	// 如果没有登录用户，则不允许获取私密Echo
	if userId == authModel.NO_USER_LOGINED {
		// 如果Echo是私密的，则不允许获取
		if echo.Private {
			// 不允许通过ID获取私密Echo
			return nil, errors.New(commonModel.NO_PERMISSION_DENIED)
		}
	} else {
		// 如果用户已经登录,获取当前登录用户
		user, err := echoService.commonService.CommonGetUserByUserId(userId)
		if err != nil {
			return nil, err
		}

		if echo.Private {
			if !user.IsAdmin {
				return nil, errors.New(commonModel.NO_PERMISSION_DENIED)
			}

			return echo, nil
		}
	}

	// 刷新图片URL (暂不处理，防止拖慢详情加载速度)
	// echoService.commonService.RefreshEchoImageURL(echo)

	// 返回Echo
	return echo, nil
}

// GetAllTags 获取所有标签
func (echoService *EchoService) GetAllTags() ([]model.Tag, error) {
	tags, err := echoService.echoRepository.GetAllTags()
	if err != nil {
		return nil, err
	}

	return tags, nil
}

// DeleteTag 删除标签
func (echoService *EchoService) DeleteTag(userid, id uint) error {
	user, err := echoService.commonService.CommonGetUserByUserId(userid)
	if err != nil {
		return err
	}
	if !user.IsAdmin {
		return errors.New(commonModel.NO_PERMISSION_DENIED)
	}

	return echoService.txManager.Run(func(ctx context.Context) error {
		return echoService.echoRepository.DeleteTagById(ctx, id)
	})
}

// ProcessEchoTags 处理Echo的标签
func (echoService *EchoService) ProcessEchoTags(ctx context.Context, echo *model.Echo) error {
	var processedTags []model.Tag

	// 一次性查询已有标签
	var names []string
	for _, tag := range echo.Tags {
		name := strings.TrimSpace(strings.TrimPrefix(tag.Name, "#"))
		if name != "" {
			names = append(names, name)
		}
	}

	existingTags, err := echoService.echoRepository.GetTagsByNames(names)
	if err != nil {
		return err
	}

	existingMap := make(map[string]*model.Tag)
	for _, t := range existingTags {
		existingMap[t.Name] = t
	}

	// 处理标签（在同一事务内）
	for _, name := range names {
		if existing, ok := existingMap[name]; ok {
			// 标签已存在
			if err := echoService.echoRepository.IncrementTagUsageCount(ctx, existing.ID); err != nil {
				return err
			}
			processedTags = append(processedTags, *existing)
		} else {
			// 新建标签
			newTag := model.Tag{Name: name, UsageCount: 1}
			if err := echoService.echoRepository.CreateTag(ctx, &newTag); err != nil {
				return err
			}
			processedTags = append(processedTags, newTag)
		}
	}

	echo.Tags = processedTags
	return nil
}

// GetEchosByTagId 获取指定标签 ID 的 Echo 列表
func (echoService *EchoService) GetEchosByTagId(
	userId, tagId uint,
	pageQueryDto commonModel.PageQueryDto,
) (commonModel.PageQueryResult[[]model.Echo], error) {
	if pageQueryDto.Page < 1 {
		pageQueryDto.Page = 1
	}
	if pageQueryDto.PageSize < 1 || pageQueryDto.PageSize > 100 {
		pageQueryDto.PageSize = 10
	}
	pageQueryDto.Search = strings.TrimSpace(pageQueryDto.Search)

	// 管理员登陆则支持查看隐私数据，否则不允许
	showPrivate := false
	if userId == authModel.NO_USER_LOGINED {
		showPrivate = false
	} else {
		user, err := echoService.commonService.CommonGetUserByUserId(userId)
		if err != nil {
			return commonModel.PageQueryResult[[]model.Echo]{}, err
		}
		if user.IsAdmin {
			showPrivate = true
		} else {
			showPrivate = false
		}
	}

	echos, total, err := echoService.echoRepository.GetEchosByTagId(
		tagId,
		pageQueryDto.Page,
		pageQueryDto.PageSize,
		pageQueryDto.Search,
		showPrivate,
	)
	if err != nil {
		return commonModel.PageQueryResult[[]model.Echo]{}, err
	}

	return commonModel.PageQueryResult[[]model.Echo]{
		Items: echos,
		Total: total,
	}, nil
}

// GetEchosByDate 获取指定日期范围的 Echo 列表
func (echoService *EchoService) GetEchosByDate(
	userId uint,
	startDate, endDate string,
	pageQueryDto commonModel.PageQueryDto,
) (commonModel.PageQueryResult[[]model.Echo], error) {
	if pageQueryDto.Page < 1 {
		pageQueryDto.Page = 1
	}
	if pageQueryDto.PageSize < 1 || pageQueryDto.PageSize > 100 {
		pageQueryDto.PageSize = 10
	}
	pageQueryDto.Search = strings.TrimSpace(pageQueryDto.Search)

	// 管理员登陆则支持查看隐私数据，否则不允许
	showPrivate := false
	if userId == authModel.NO_USER_LOGINED {
		showPrivate = false
	} else {
		user, err := echoService.commonService.CommonGetUserByUserId(userId)
		if err != nil {
			return commonModel.PageQueryResult[[]model.Echo]{}, err
		}
		if user.IsAdmin {
			showPrivate = true
		} else {
			showPrivate = false
		}
	}

	echos, total, err := echoService.echoRepository.GetEchosByDate(
		startDate,
		endDate,
		pageQueryDto.Page,
		pageQueryDto.PageSize,
		pageQueryDto.Search,
		showPrivate,
	)
	if err != nil {
		return commonModel.PageQueryResult[[]model.Echo]{}, err
	}

	return commonModel.PageQueryResult[[]model.Echo]{
		Items: echos,
		Total: total,
	}, nil
}
